<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ doc['title'] }} - Contract View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=JetBrains+Mono:wght@400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Marked.js for client-side markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body class="document-view">
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <nav class="top-nav">
        <a href="/" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Search
        </a>
        <div class="doc-title">{{ doc['title'] }}</div>
    </nav>

    <main class="document-container">
        {% if query %}
        <div class="search-context-bar">
            <a href="{{ url_for('view_document', doc_id=doc.id, q=query) }}" class="back-link">
                ‚Üê Back to Results for "{{ query }}"
            </a>

        </div>
        {% endif %}

        <div class="doc-layout" style="display: flex; height: calc(100vh - 80px); overflow: hidden;">

            <!-- Left Pane: Markdown/Text Content -->
            <main class="doc-content" style="flex: 1; overflow-y: auto; padding: 2rem; max-width: 50%;">
                <header class="doc-header">
                    <a href="{{ url_for('index', q=query) }}" class="back-link">&larr; Back to Search</a>
                    <h1>{{ doc.title }}</h1>
                    <div class="doc-meta">Filename: {{ doc.filename }}</div>

                    <!-- Toggle PDF Button -->
                    <button onclick="togglePdf()" class="button secondary small" style="margin-top: 1rem;">Toggle PDF
                        Viewer</button>
                </header>

                <!-- Navigation Controls -->
                <div class="nav-controls sticky-nav">
                    <div class="nav-group page-nav">
                        {% if prev_page %}
                        <a href="{{ url_for('view_document', doc_id=doc.id, page=prev_page, q=query) }}"
                            class="button small">&larr; Page {{ prev_page }}</a>
                        {% else %}
                        <span class="button small disabled">&larr; Prev</span>
                        {% endif %}

                        <span class="current-indicator">Page <strong>{{ current_page }}</strong> of {{ total_pages
                            }}</span>

                        {% if next_page %}
                        <a href="{{ url_for('view_document', doc_id=doc.id, page=next_page, q=query) }}"
                            class="button small">Page {{ next_page }} &rarr;</a>
                        {% else %}
                        <span class="button small disabled">Next &rarr;</span>
                        {% endif %}
                    </div>

                    {% if query %}
                    <div class="nav-group match-nav">
                        <span class="nav-label">Matches:</span>
                        {% if prev_result %}
                        <a href="{{ url_for('view_document', doc_id=doc.id, page=prev_result, q=query) }}"
                            class="button small result-btn">&larr; Prev Match</a>
                        {% else %}
                        <span class="button small disabled result-btn">&larr; Prev Match</span>
                        {% endif %}

                        {% if next_result %}
                        <a href="{{ url_for('view_document', doc_id=doc.id, page=next_result, q=query) }}"
                            class="button small result-btn">Next Match &rarr;</a>
                        {% else %}
                        <span class="button small disabled result-btn">Next Match &rarr;</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Debug Info (Optional) -->
                {#
                <div
                    style="background: #333; color: lime; padding: 10px; margin-bottom: 10px; font-family: monospace; font-size: 0.8em;">
                    Query: {{ query }} <br>
                    Current Page: {{ current_page }} <br>
                    Total Pages: {{ total_pages }} <br>
                    Prev/Next Page: {{ prev_page }} / {{ next_page }} <br>
                    Prev/Next Result: {{ prev_result }} / {{ next_result }}
                </div>
                #}

                <div class="markdown-body">
                    {{ content | safe }}
                </div>
            </main>

            <!-- Right Pane: PDF Viewer -->
            <aside id="pdf-pane" class="pdf-viewer"
                style="flex: 1; border-left: 1px solid var(--border); background: #333; display: flex; flex-direction: column;">
                <div
                    style="padding: 0.5rem; background: #222; border-bottom: 1px solid #444; color: #fff; display: flex; justify-content: space-between; align-items: center;">
                    <span>Original PDF (Page {{ current_page }})</span>
                    <a href="/pdfs/{{ doc.filename.replace('.md', '.pdf') }}" download class="button small">Download</a>
                </div>
                <!-- Embed PDF with page parameter using browser native viewer fragments -->
                <!-- #page=3 -->
                <iframe src="/pdfs/{{ doc.filename.replace('.md', '.pdf') }}#page={{ current_page }}" width="100%"
                    height="100%" style="border: none;"></iframe>
            </aside>

        </div>
    </main>

    <script>
        function togglePdf() {
            const pane = document.getElementById('pdf-pane');
            const content = document.querySelector('.doc-content');

            if (pane.style.display === 'none') {
                pane.style.display = 'flex';
                content.style.maxWidth = '50%';
            } else {
                pane.style.display = 'none';
                content.style.maxWidth = '100%';
            }
        }

        // Auto-scroll to mark
        document.addEventListener("DOMContentLoaded", function () {
            const mark = document.querySelector("mark");
            if (mark) {
                mark.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });
    </script>
</body>

</html>